---
title: JSON Responses and Generative UI
---

import { CoAgentsEnterpriseCTA } from "@/components/react/coagents/coagents-enterprise-cta.tsx";
import { Accordion, Accordions } from 'fumadocs-ui/components/accordion';

Including humans in the loop (HITL) using LangGraph and CoAgentKit is simple, but requires an understanding of your app's workflow graph and how to navigate it as users interact with your agent.

In this example, we'll build a simple app that can generate and send emails, asking the user to review and confirm each one before sending.

The full source code for this example is available [here on GitHub](https://github.com/copilotkit/copilotkit/tree/main/examples/coagents-qa); you can run it locally by following the instructions in the README. The full code includes examples for both OpenAI and Anthropic models; for simplicity, here we'll focus on the OpenAI version.

## Setting up the React frontend

This component uses the `useCopilotAction` hook and its `renderAndWait` argument to give the user an inline, visual UI to confirm or cancel sending an email. This Q&A is rendered inside of a `CopilotPopup` component; most chat interactions are handled out of the box, and we only need to implement visual UI for the specific questions and answers we want to handle.

In the `renderAndWait` function, we use the `handler` argument to send a "CANCEL" or "SEND" message back to the agent when the user clicks the relevant button.

```tsx filename="app/Mailer.tsx"
"use client";

import { useCopilotAction } from "@copilotkit/react-core";
import { CopilotPopup } from "@copilotkit/react-ui";

export function Mailer() {
  useCopilotAction({
    name: "EmailTool",
    disabled: true,
    parameters: [
      {
        name: "the_email",
      },
    ],
    renderAndWait: ({ args, status, handler }) => {
      return (
        <div className="p-4 bg-gray-100 rounded-lg">
          <div className="font-bold text-lg mb-2">Send this email?</div>
          <div className="text-gray-700">{args.the_email}</div>
          {status === "executing" && (
            <div className="mt-4 flex justify-end space-x-2">
              <button
                onClick={() => handler("CANCEL")}
                className="px-4 py-2 bg-slate-400 text-white rounded"
              >
                Cancel
              </button>
              <button
                onClick={() => handler("SEND")}
                className="px-4 py-2 bg-blue-500 text-white rounded"
              >
                Send
              </button>
            </div>
          )}
        </div>
      );
    },
  });

  return (
    <div className="flex flex-col items-center justify-center h-screen">
      <div className="text-2xl">Email Q&A example</div>
      <div>e.g. write an email to the CEO of OpenAI asking for a meeting</div>

      <CopilotPopup defaultOpen={true} clickOutsideToClose={false} />
    </div>
  );
}
```

Having set up the frontend, we can now turn to the Python side to configure the agent.

## Setting up the Python agent

<Accordions>

<Accordion title="Complete Python agent code">

```python filename="agent/my_agent/agent.py"
"""Test Q&A Agent"""

import os
from typing import Any, cast
from langchain_openai import ChatOpenAI
from langchain_anthropic import ChatAnthropic
from langgraph.graph import StateGraph, END
from langgraph.graph import MessagesState
from langgraph.checkpoint.memory import MemorySaver
from langchain_core.runnables import RunnableConfig
from langchain_core.messages import HumanMessage, ToolMessage
from copilotkit.langchain import (
  copilotkit_customize_config, copilotkit_exit, copilotkit_emit_message
)
from pydantic import BaseModel, Field


def get_model():
    """Get the model (OpenAI gpt-4o)"""
    return ChatOpenAI(temperature=0, model="gpt-4o")

class EmailAgentState(MessagesState):
    """Email Agent State"""
    email: str

class EmailTool(BaseModel):
    """Write an email."""
    the_email: str = Field(description="The email to be written.")

async def write_email_node(state: EmailAgentState, config: RunnableConfig):
    """
    Write an email.
    """

    config = copilotkit_customize_config(
        config,
        emit_tool_calls=True,
    )

    # Instructions (aka system prompt) for the email agent.
    # These will be passed in first so the LLM knows its role and
    # how best to respond to requests
    instructions = "You're an email assistant that communicates with the user to write messages to important people. The audience for these emails are busy CEOs and founders; your tone should be professional, confident, and friendly. Please keep emails succinct and to the point without being rude or unclear. The user will give you a prompt for the email, and you will ask them to approve it before sending."

    email_model = get_model().bind_tools(
        [EmailTool],
        tool_choice="EmailTool"
    )

    response = await email_model.ainvoke([
        *state["messages"],
        HumanMessage(
            content=instructions
        )
    ], config)

    tool_calls = cast(Any, response).tool_calls

    email = tool_calls[0]["args"]["the_email"]

    return {
        "email": email,
    }

async def send_email_node(state: EmailAgentState, config: RunnableConfig):
    """
    Send an email.
    """

    config = copilotkit_customize_config(
        config,
        emit_messages=True,
    )

    await copilotkit_exit(config)

    # get the last message and cast to ToolMessage
    last_message = cast(ToolMessage, state["messages"][-1])
    if last_message.content == "CANCEL":
        await copilotkit_emit_message(config, "❌ Cancelled sending email.")
    else:
        await copilotkit_emit_message(config, "✅ Sent email.")


    return {
        "messages": state["messages"],
    }


workflow = StateGraph(EmailAgentState)
workflow.add_node("write_email_node", write_email_node)
workflow.add_node("send_email_node", send_email_node)
workflow.set_entry_point("write_email_node")

workflow.add_edge("write_email_node", "send_email_node")
workflow.add_edge("send_email_node", END)
graph = workflow.compile(checkpointer=MemorySaver(), interrupt_after=["write_email_node"])
```

</Accordion>
</Accordions>

This Python code defines a LangGraph agent that composes and sends emails, following the following system prompt:

> You're an email assistant that communicates with the user to write messages to important people. The audience for these emails are busy CEOs and founders; your tone should be professional, confident, and friendly. Please keep emails succinct and to the point without being rude or unclear. The user will give you a prompt for the email, and you will ask them to approve it before sending.

The agent's workflow consists of two nodes: `write_email_node` and `send_email_node`. The first is where the AI agent writes the email content, and the second is where the user confirms or cancels sending the email.

We've also told the agent to interrupt after the `write_email_node`, so that the user's input is captured and used to update the agent state before the email is sent:

```python title="agent/my_agent/agent.py" {11-16}
workflow = StateGraph(EmailAgentState)
workflow.add_node("write_email_node", write_email_node)
workflow.add_node("send_email_node", send_email_node)
workflow.set_entry_point("write_email_node")

workflow.add_edge("write_email_node", "send_email_node")
workflow.add_edge("send_email_node", END)
graph = workflow.compile(checkpointer=MemorySaver(), interrupt_after=["write_email_node"])
```

In the `send_email_node` method, we check for a "CANCEL" message to let the user cancel sending the email, and otherwise confirm that it was sent successfully.

```python title="agent/my_agent/agent.py" {10-12}
async def send_email_node(state: EmailAgentState, config: RunnableConfig):
    """
    Send an email.
    """

    config = copilotkit_customize_config(
        config,
        emit_messages=True,
    )

    await copilotkit_exit(config)

    # get the last message and cast to ToolMessage
    last_message = cast(ToolMessage, state["messages"][-1])
    if last_message.content == "CANCEL":
        await copilotkit_emit_message(config, "❌ Cancelled sending email.")
    else:
        await copilotkit_emit_message(config, "✅ Sent email.")


    return {
        "messages": state["messages"],
    }
```


Here's the code in action:

<video src="/images/coagents/copilotkit-mailer-demo.mp4" controls className="w-full [aspect-ratio:100/72] max-w-xl mx-auto" />

You can easily extend this example to handle more complex interactions, or to add more steps to the email workflow.

<CoAgentsEnterpriseCTA />